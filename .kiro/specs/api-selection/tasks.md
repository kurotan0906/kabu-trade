# Implementation Plan: api-selection

> 目的: 外部株式データAPIの候補を、要件（プライム市場対応、直近データ鮮度、無料開始、調整の扱い）と評価軸に基づいて比較し、PoCで成立性を確認し、採用判断とフォールバック案を再現可能な形で残す。

- [x] 1. 候補・評価軸・合否条件・根拠を機械可読に扱えるようにする
- [x] 1.1 候補APIと評価対象スコープを表現するデータモデルを用意する (P)
  - 候補APIごとに「提供元/名称、対応データ種別、認証方式、料金/利用開始条件、利用規約の要点」を保持できる
  - 「日本のプライム市場対応」の判定結果と根拠を保持できる
  - 直近データ欠落（期間/影響/回避策）を候補ごとに記録できる
  - 機密情報（APIキー等）を格納しない前提で設計する
  - _Requirements: 1.1, 1.2, 1.3, 1.5, 4.3_
- [x] 1.2 評価軸と合否条件（鮮度/調整/無料開始含む）を表現するデータモデルを用意する (P)
  - 鮮度の最低要件を「合否条件」として表現できる
  - 調整済み/未調整データ方針を評価項目として表現できる
  - 評価軸ごとに判定方法（確認手段）と最低要件（合否条件）を表現できる
  - _Requirements: 2.1, 2.2, 2.3, 2.6, 2.7_
- [x] 1.3 評価結果（候補×評価軸）と根拠参照を保持できるようにする (P)
  - 評価結果（合否/スコア/所見）と、根拠（参照元、確認日、リンク/記録）を紐づけられる
  - 規約・価格・仕様の一次情報を「参照」として追跡できる
  - _Requirements: 2.5_

- [x] 2. 候補APIの一次情報を収集し、合否（ゲート条件含む）を評価できるようにする
- [x] 2.1 一次情報の収集フローを実装し、収集結果を根拠として保存する (P)
  - 公式ドキュメントURLや確認日を必須項目として記録する
  - 取得できない/不明な項目は「不明（要確認）」として扱い、誤って合格判定しない
  - _Requirements: 2.5_
- [x] 2.2 ゲート条件による除外ロジックを実装する
  - 「日本のプライム市場対応」「データ鮮度の最低要件」を満たさない候補を初期段階の採用対象から除外できる
  - 「無料開始」は優先条件として評価しつつ、鮮度未達の場合はフォールバック案の有無で扱いを分岐できる
  - 除外/保留時は理由（どの条件に不適合か）を必ず記録する
  - _Requirements: 1.2, 2.3, 2.6, 3.4_
- [x] 2.3 利用規約上の制限（再配布不可など）を検知・記録し、矛盾時に判定を保留/不採用にできる
  - 禁止事項とプロダクト要件の矛盾を表現できる
  - 矛盾がある場合に「不採用」または「要スコープ変更」として扱える
  - _Requirements: 2.4_
- [x] 2.4 コーポレートアクション調整の方針を候補ごとに整理し、利用者向け注意点に変換する (P)
  - 調整済み/未調整の扱いと、指標計算・チャートへの影響を記録できる
  - 初心者が誤解しやすい点（例: 分割で過去価格が変わる）を注意事項として抽出できる
  - _Requirements: 2.7, 4.4_

- [x] 3. PoC（疎通検証）を実行し、成立性と制約を候補ごとに記録できるようにする
- [x] 3.1 候補APIごとの疎通検証を実行するためのPoCランナーを実装する
  - 認証情報が未設定の場合は安全に失敗し、必要な認証情報の種類を明示して記録する
  - タイムアウト/レート制限/認証失敗を分類して記録する
  - _Requirements: 3.1_
- [x] 3.2 (P) 既存の実データ候補（kabuステーション系）に対するPoCを実装する
  - 既存の外部データ取得の差し替え前提と矛盾しない形で疎通できる
  - トークン更新や強制ログアウト等の制約を「制約」として記録できる
  - _Requirements: 1.4, 3.3_
- [x] 3.3 (P) 無料で開始できる日本株候補（例: JPX系）に対するPoCを実装する
  - 無料枠の制約（遅延/呼び出し制限/期間制限など）を「制約」として記録できる
  - プライム市場対応の確認方法（市場区分の扱い等）を根拠として記録できる
  - _Requirements: 1.2, 2.3, 3.1, 3.3_
- [x] 3.4 鮮度未達の候補が出た場合のフォールバック構成を作成し、成立性を検証する
  - 直近データだけ別APIで補う等の構成を候補として定義できる
  - フォールバック構成の前提/制約/費用/運用を記録し、採用判断に反映できる
  - _Requirements: 1.5, 3.4_

- [x] 4. 選定結果（採用/不採用）とリスク・導入前提を再現可能な形で出力できるようにする
- [x] 4.1 (P) 比較表（CandidateMatrix）を生成し、候補ごとの合否と根拠をまとめて出力する
  - 評価軸ごとの判定と、ゲート条件の合否を一覧化できる
  - 鮮度の合否（最低要件の満否）と、欠落期間/影響/回避策を一覧化できる
  - 第三者が追試できるよう、参照根拠（参照元/確認日）を含めて出力できる
  - _Requirements: 1.3, 1.5, 2.1, 2.2, 2.5, 2.6_
- [x] 4.2 採用判断（DecisionRecord）を生成し、採用/不採用理由と方針を出力する
  - 採用API（単一/複数）と採用理由、不採用理由を出力できる
  - 導入に必要な前提を整理して出力できる（機密情報は含めない）
  - 初心者向けに明示すべき制約（注意事項）を付帯情報として出力できる
  - _Requirements: 4.1, 4.3, 4.4_
- [x] 4.3 リスク登録（RiskRegister）を生成し、主要リスクと対策を出力する
  - 料金変動/レート制限/仕様変更/提供終了などのリスクを記録できる
  - 直近欠落/遅延など「鮮度」由来のリスクも含めて記録できる
  - 対策（モック維持、代替候補、監視）を紐づけて出力できる
  - _Requirements: 1.5, 4.2_

- [x] 5. 変更検知と更新運用を支える仕組みを実装する
- [x] 5.1 (P) 参照根拠（リンク/確認日）を再チェックできる仕組みを用意する
  - 参照先が変わった/取得できない場合に検知し、影響評価のトリガーにできる
  - _Requirements: 5.1_
- [x] 5.2 更新履歴を記録できるようにし、更新時に差分と影響を残せる
  - 更新日、変更点、判断への影響を記録できる
  - _Requirements: 5.2_
- [x] 5.3 鮮度/期間/遅延の仕様変更を検知した場合に、致命条件の再評価を必須化する
  - 鮮度の仕様が変わったときに、採用方針とフォールバック構成の見直しをトリガーできる
  - _Requirements: 5.3_

- [x] 6. テストで要件を担保する
- [x] 6.1 (P) 評価軸/合否条件/ゲート条件の判定ロジックを単体テストで検証する
  - 無料開始要件とプライム市場要件の判定が期待どおりに機能する
  - 鮮度ゲート（最低要件）とフォールバック必須条件が期待どおりに機能する
  - _Requirements: 1.2, 2.2, 2.3, 2.6, 3.4_
- [x] 6.2 (P) PoCランナーの異常系（認証失敗/タイムアウト/レート制限）を統合テストで検証する
  - 異常系が分類され、根拠として記録される
  - _Requirements: 3.1, 2.5_

